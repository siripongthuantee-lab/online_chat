<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó - Online Talk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        .neobrutalism-shadow {
            box-shadow: 8px 8px 0px 0px rgba(0,0,0,1);
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        video {
            transform: scaleX(-1);
        }
    </style>
</head>
<body class="bg-[#f5f1e8]">
    <!-- Room Header -->
    <div class="bg-white border-b-4 border-black p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-4">
                <button id="leaveRoomBtn" class="px-4 py-2 bg-white border-2 border-black rounded-lg hover:bg-gray-100">
                    ‚Üê ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á
                </button>
                <div class="bg-[#FFD93D] border-2 border-black rounded-lg px-4 py-2">
                    <span class="font-bold">‡πÇ‡∏Ñ‡πâ‡∏î: <span id="roomCode">XXXXXX</span></span>
                </div>
                <button id="copyCodeBtn" class="px-4 py-2 bg-white border-2 border-black rounded-lg hover:bg-gray-100">
                    üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                </button>
            </div>
            <div class="flex items-center gap-2">
                <span class="bg-green-400 border-2 border-black rounded-full px-4 py-1">
                    <span id="userCount">1</span> ‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                </span>
            </div>
        </div>
    </div>

    <!-- Main Room Content -->
    <div class="max-w-7xl mx-auto p-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Video Area (2/3) -->
            <div class="lg:col-span-2">
                <div class="bg-white border-4 border-black rounded-2xl p-6 neobrutalism-shadow">
                    <h3 class="text-xl font-bold mb-4">üé• ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</h3>
                    
                    <!-- Video Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <!-- Local Video -->
                        <div class="aspect-video bg-gray-800 rounded-xl border-4 border-black relative overflow-hidden">
                            <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover hidden"></video>
                            <div id="localVideoOff" class="absolute inset-0 flex items-center justify-center bg-gray-800">
                                <svg width="100" height="100">
                                    <circle cx="50" cy="50" r="40" fill="white" stroke="black" stroke-width="2"/>
                                    <circle cx="42" cy="45" r="4" fill="black"/>
                                    <circle cx="58" cy="45" r="4" fill="black"/>
                                    <path d="M 38 58 Q 50 65 62 58" stroke="black" stroke-width="2" fill="none"/>
                                </svg>
                            </div>
                            <div class="absolute bottom-3 left-3 bg-black/80 text-white px-3 py-1 rounded-full text-sm" id="myUsername">
                                ‡∏Ñ‡∏∏‡∏ì
                            </div>
                        </div>
                        
                        <!-- Remote Video -->
                        <div class="aspect-video bg-gray-800 rounded-xl border-4 border-black relative overflow-hidden">
                            <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover hidden"></video>
                            <div id="waitingMessage" class="absolute inset-0 flex items-center justify-center text-white">
                                <p>‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...</p>
                            </div>
                            <div id="remoteUsername" class="hidden absolute bottom-3 left-3 bg-black/80 text-white px-3 py-1 rounded-full text-sm">
                                ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex items-center justify-center gap-4 pt-4 border-t-4 border-black">
                        <button id="micBtn" class="w-16 h-16 bg-red-500 text-white border-4 border-black rounded-full flex items-center justify-center hover:bg-red-600 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                            <span class="text-2xl">üîá</span>
                        </button>
                        <button id="videoBtn" class="w-16 h-16 bg-red-500 text-white border-4 border-black rounded-full flex items-center justify-center hover:bg-red-600 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                            <span class="text-2xl">üö´</span>
                        </button>
                        <button id="endCallBtn" class="w-16 h-16 bg-red-500 text-white border-4 border-black rounded-full flex items-center justify-center hover:bg-red-600 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                            <span class="text-2xl">üìû</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Area (1/3) -->
            <div class="lg:col-span-1">
                <div class="bg-white border-4 border-black rounded-2xl neobrutalism-shadow flex flex-col h-[600px]">
                    <!-- Chat Header -->
                    <div class="border-b-4 border-black p-4 bg-[#FFD93D]">
                        <h3 class="text-xl font-bold">üí¨ ‡πÅ‡∏ä‡∏ó</h3>
                    </div>

                    <!-- Messages -->
                    <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div class="bg-gray-100 border-2 border-black rounded-lg p-3 text-center">
                            <p class="text-sm">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó!</p>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="border-t-4 border-black p-3">
                        <div class="flex gap-2">
                            <input type="text" id="messageInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." 
                                class="flex-1 border-2 border-black rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            <button id="sendMessageBtn" class="bg-black text-white border-2 border-black rounded-lg px-4 py-2 hover:bg-gray-800 font-bold shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]">
                                ‡∏™‡πà‡∏á
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDyAVYvI5O327uh6LZAJELHpa9XHQ8_J3Q",
            authDomain: "chat-online-project-187e9.firebaseapp.com",
            databaseURL: "https://chat-online-project-187e9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chat-online-project-187e9",
            storageBucket: "chat-online-project-187e9.firebasestorage.app",
            messagingSenderId: "238726912803",
            appId: "1:238726912803:web:342c5669f6edd8cbb48a96",
            measurementId: "G-SL9N8KG89G"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Get room code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code') || 'XXXXXX';
        const roomType = urlParams.get('type') || 'oneOnOne';
        
        document.getElementById('roomCode').textContent = roomCode;

        let currentUser = null;
        let localStream = null;
        let peerConnection = null;
        let isMicOn = false;  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡∏¥‡∏î
        let isVideoOn = false;  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡∏¥‡∏î

        // ICE servers configuration
        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 border-green-500 text-green-700',
                error: 'bg-red-100 border-red-500 text-red-700',
                info: 'bg-blue-100 border-blue-500 text-blue-700'
            };
            
            const toast = document.createElement('div');
            toast.className = `${colors[type]} border-2 rounded-lg p-4 mb-2 shadow-lg`;
            toast.style.animation = 'slideIn 0.3s ease-out';
            toast.textContent = message;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize local media (‡πÅ‡∏ï‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ)
        async function initLocalMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                
                // ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡∏Ñ‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                localStream.getVideoTracks().forEach(track => track.enabled = false);
                localStream.getAudioTracks().forEach(track => track.enabled = false);
                
                showToast('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÑ‡∏°‡∏Ñ‡πå)', 'success');
                return true;
            } catch (error) {
                console.error('Error accessing media devices:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡∏Ñ‡πå‡πÑ‡∏î‡πâ', 'error');
                return false;
            }
        }

        // Create peer connection
        function createPeerConnection(userId) {
            peerConnection = new RTCPeerConnection(iceServers);

            // Add local stream tracks
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // Handle incoming tracks
            peerConnection.ontrack = (event) => {
                const remoteVideo = document.getElementById('remoteVideo');
                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    remoteVideo.classList.remove('hidden');
                    document.getElementById('waitingMessage').classList.add('hidden');
                    document.getElementById('remoteUsername').classList.remove('hidden');
                    showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    database.ref(`rooms/${roomCode}/candidates/${currentUser.uid}`).push({
                        candidate: event.candidate.toJSON(),
                        timestamp: Date.now()
                    });
                }
            };

            // Monitor connection state
            peerConnection.onconnectionstatechange = () => {
                console.log('Connection state:', peerConnection.connectionState);
                if (peerConnection.connectionState === 'disconnected') {
                    showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢', 'error');
                }
            };

            return peerConnection;
        }

        // Create and send offer
        async function createOffer(targetUserId) {
            if (!peerConnection) {
                createPeerConnection(targetUserId);
            }

            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await database.ref(`rooms/${roomCode}/offers/${currentUser.uid}`).set({
                    offer: {
                        type: offer.type,
                        sdp: offer.sdp
                    },
                    targetUserId: targetUserId,
                    timestamp: Date.now()
                });

                console.log('Offer sent');
            } catch (error) {
                console.error('Error creating offer:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
            }
        }

        // Handle incoming offer
        async function handleOffer(offerData, offererId) {
            if (!peerConnection) {
                createPeerConnection(offererId);
            }

            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData.offer));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                await database.ref(`rooms/${roomCode}/answers/${currentUser.uid}`).set({
                    answer: {
                        type: answer.type,
                        sdp: answer.sdp
                    },
                    targetUserId: offererId,
                    timestamp: Date.now()
                });

                console.log('Answer sent');
            } catch (error) {
                console.error('Error handling offer:', error);
            }
        }

        // Handle incoming answer
        async function handleAnswer(answerData) {
            if (peerConnection) {
                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answerData.answer));
                    console.log('Answer received and set');
                } catch (error) {
                    console.error('Error handling answer:', error);
                }
            }
        }

        // Handle incoming ICE candidates
        function handleCandidate(candidateData) {
            if (peerConnection && candidateData.candidate) {
                const candidate = new RTCIceCandidate(candidateData.candidate);
                peerConnection.addIceCandidate(candidate).catch(e => {
                    console.error('Error adding ICE candidate:', e);
                });
            }
        }

        // Listen for signaling data
        function setupSignalingListeners() {
            // Listen for offers
            database.ref(`rooms/${roomCode}/offers`).on('child_added', (snapshot) => {
                const offererId = snapshot.key;
                if (offererId !== currentUser.uid) {
                    const offerData = snapshot.val();
                    if (offerData.targetUserId === currentUser.uid || !offerData.targetUserId) {
                        handleOffer(offerData, offererId);
                    }
                }
            });

            // Listen for answers
            database.ref(`rooms/${roomCode}/answers`).on('child_added', (snapshot) => {
                const answererId = snapshot.key;
                if (answererId !== currentUser.uid) {
                    const answerData = snapshot.val();
                    if (answerData.targetUserId === currentUser.uid) {
                        handleAnswer(answerData);
                    }
                }
            });

            // Listen for ICE candidates
            database.ref(`rooms/${roomCode}/candidates`).on('child_added', (snapshot) => {
                const userId = snapshot.key;
                if (userId !== currentUser.uid) {
                    snapshot.ref.on('child_added', (candidateSnapshot) => {
                        const candidateData = candidateSnapshot.val();
                        handleCandidate(candidateData);
                    });
                }
            });
        }

        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'LoginPage.html';
                return;
            }

            currentUser = user;
            document.getElementById('myUsername').textContent = user.displayName || user.email.split('@')[0];

            // Initialize media (‡πÅ‡∏ï‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ)
            const mediaReady = await initLocalMedia();
            if (!mediaReady) {
                return;
            }

            // Join room
            const roomRef = database.ref('rooms/' + roomCode);
            const snapshot = await roomRef.once('value');
            
            if (snapshot.exists()) {
                // Add user to members
                await roomRef.child('members').update({
                    [user.uid]: {
                        username: user.displayName || user.email.split('@')[0],
                        joinedAt: Date.now()
                    }
                });
                
                // Setup signaling
                setupSignalingListeners();
                
                // Listen for messages
                listenToMessages();
                
                // Listen for members
                listenToMembers();

                // Check if there are other users to connect with
                const membersSnapshot = await roomRef.child('members').once('value');
                const members = membersSnapshot.val() || {};
                const otherUsers = Object.keys(members).filter(uid => uid !== user.uid);
                
                if (otherUsers.length > 0) {
                    // Create offer to first other user
                    setTimeout(() => createOffer(otherUsers[0]), 1000);
                }
            } else {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ', 'error');
                setTimeout(() => {
                    window.location.href = 'Index.html';
                }, 2000);
            }
        });

        // Listen to messages
        function listenToMessages() {
            const messagesRef = database.ref('rooms/' + roomCode + '/messages');
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
            });
        }

        // Listen to members
        function listenToMembers() {
            const membersRef = database.ref('rooms/' + roomCode + '/members');
            membersRef.on('value', (snapshot) => {
                const members = snapshot.val() || {};
                const count = Object.keys(members).length;
                document.getElementById('userCount').textContent = count;

                // Update remote username if available
                const otherUsers = Object.keys(members).filter(uid => uid !== currentUser.uid);
                if (otherUsers.length > 0) {
                    const otherUser = members[otherUsers[0]];
                    document.getElementById('remoteUsername').textContent = otherUser.username || '‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
                }
            });
        }

        // Display message
        function displayMessage(message) {
            const container = document.getElementById('messagesContainer');
            const messageEl = document.createElement('div');
            
            const isMyMessage = message.userId === currentUser.uid;
            
            messageEl.className = 'space-y-1';
            messageEl.innerHTML = `
                <div class="flex items-center gap-2 ${isMyMessage ? 'justify-end' : ''}">
                    ${!isMyMessage ? `
                        <div class="w-8 h-8 bg-[#6BCB77] rounded-full border-2 border-black flex items-center justify-center text-xs">
                            ${message.username.charAt(0)}
                        </div>
                    ` : ''}
                    <span class="text-sm font-bold">${message.username}</span>
                </div>
                <div class="${isMyMessage ? 'flex justify-end' : ''}">
                    <div class="${isMyMessage ? 'bg-[#FFD93D]' : 'bg-gray-200'} border-2 border-black rounded-lg px-3 py-2 inline-block max-w-xs break-words">
                        ${message.text}
                    </div>
                </div>
                <div class="${isMyMessage ? 'text-right' : ''} text-xs text-gray-500 px-2">
                    ${new Date(message.timestamp).toLocaleTimeString('th-TH')}
                </div>
            `;
            
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message && currentUser) {
                try {
                    const messagesRef = database.ref('rooms/' + roomCode + '/messages');
                    await messagesRef.push({
                        userId: currentUser.uid,
                        username: currentUser.displayName || currentUser.email.split('@')[0],
                        text: message,
                        timestamp: Date.now()
                    });
                    
                    input.value = '';
                } catch (error) {
                    console.error('Send message error:', error);
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }

        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Toggle Mic
        document.getElementById('micBtn').addEventListener('click', function() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isMicOn = !isMicOn;
                    audioTrack.enabled = isMicOn;
                    this.querySelector('span').textContent = isMicOn ? 'üé§' : 'üîá';
                    this.className = isMicOn 
                        ? 'w-16 h-16 bg-white border-4 border-black rounded-full flex items-center justify-center hover:bg-gray-100 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]'
                        : 'w-16 h-16 bg-red-500 text-white border-4 border-black rounded-full flex items-center justify-center hover:bg-red-600 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]';
                    showToast(isMicOn ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå' : '‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå', 'info');
                }
            }
        });

        // Toggle Video
        document.getElementById('videoBtn').addEventListener('click', function() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    isVideoOn = !isVideoOn;
                    videoTrack.enabled = isVideoOn;
                    this.querySelector('span').textContent = isVideoOn ? 'üìπ' : 'üö´';
                    this.className = isVideoOn 
                        ? 'w-16 h-16 bg-white border-4 border-black rounded-full flex items-center justify-center hover:bg-gray-100 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]'
                        : 'w-16 h-16 bg-red-500 text-white border-4 border-black rounded-full flex items-center justify-center hover:bg-red-600 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]';
                    
                    // Toggle video visibility
                    const localVideo = document.getElementById('localVideo');
                    const localVideoOff = document.getElementById('localVideoOff');
                    
                    if (isVideoOn) {
                        localVideo.classList.remove('hidden');
                        localVideoOff.classList.add('hidden');
                    } else {
                        localVideo.classList.add('hidden');
                        localVideoOff.classList.remove('hidden');
                    }
                    
                    showToast(isVideoOn ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á' : '‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á', 'info');
                }
            }
        });

        // Copy Room Code
        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(roomCode);
            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        });

        // Leave Room
        async function leaveRoom() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                // Stop all tracks
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }

                // Close peer connection
                if (peerConnection) {
                    peerConnection.close();
                }

                // Remove from Firebase
                if (currentUser) {
                    await database.ref('rooms/' + roomCode + '/members/' + currentUser.uid).remove();
                }

                window.location.href = 'Index.html';
            }
        }

        document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
        document.getElementById('endCallBtn').addEventListener('click', leaveRoom);

        // Handle page unload
        window.addEventListener('beforeunload', async () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
            if (currentUser) {
                await database.ref('rooms/' + roomCode + '/members/' + currentUser.uid).remove();
            }
        });
    </script>
</body>
</html>